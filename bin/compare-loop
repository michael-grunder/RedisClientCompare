#!/usr/bin/env php
<?php

declare(strict_types=1);

require __DIR__ . '/../vendor/autoload.php';

ini_set('display_errors', 'stderr');

$options = getopt('', [
    'old:',
    'new:',
    'iters::',
    'sleep::',
    'count::',
    'host::',
    'port::',
]);

if (!isset($options['old'], $options['new'])) {
    usage();
    exit(2);
}

$phpOld = $options['old'];
$phpNew = $options['new'];
$iterations = (int) ($options['iters'] ?? 0);
$sleepSeconds = (int) ($options['sleep'] ?? 0);
$commandCount = (int) ($options['count'] ?? 200);
$host = $options['host'] ?? '127.0.0.1';
$port = (int) ($options['port'] ?? 6379);

$generator = __DIR__ . '/gen-commands';
$runner = __DIR__ . '/run-commands';
$comparator = __DIR__ . '/compare-outputs';

$oldVersion = getRedisVersion($phpOld);
$newVersion = getRedisVersion($phpNew);

foreach ([$generator, $runner, $comparator] as $binary) {
    if (!is_file($binary)) {
        logError('Missing binary', ['path' => $binary]);
        logSummary('missing-binary', 0, 0, microtime(true));
        exit(2);
    }
}

$workDir = buildWorkDir();
register_shutdown_function(static function () use ($workDir): void {
    $iterator = new RecursiveIteratorIterator(
        new RecursiveDirectoryIterator($workDir, FilesystemIterator::SKIP_DOTS),
        RecursiveIteratorIterator::CHILD_FIRST
    );

    foreach ($iterator as $file) {
        $filename = $file->getPathname();
        $file->isDir() ? @rmdir($filename) : @unlink($filename);
    }

    @rmdir($workDir);
});

logInfo(
    'Loop start',
    [
        'old' => $phpOld,
        'new' => $phpNew,
        'redis' => sprintf('%s->%s', $oldVersion ?: 'N/A', $newVersion ?: 'N/A'),
        'batch' => number_format($commandCount),
        'iters' => $iterations > 0 ? number_format($iterations) : 'âˆž',
    ]
);

$iteration = 0;
$totalRuns = 0;
$totalCommands = 0;
$startTime = microtime(true);
while (true) {
    if ($iterations > 0 && $iteration >= $iterations) {
        logSummary('completed', $totalRuns, $totalCommands, $startTime);
        exit(0);
    }

    $commandsFile = sprintf('%s/cmds.%d.jsonl', $workDir, $iteration);
    $outputOld = sprintf('%s/out_old.%d.jsonl', $workDir, $iteration);
    $outputNew = sprintf('%s/out_new.%d.jsonl', $workDir, $iteration);
    $iterationStart = microtime(true);

    logInfo('Iter start', [
        'iter' => number_format($iteration),
        'batch' => number_format($commandCount),
    ]);

    $cmd = sprintf(
        '%s %s %d %s',
        escapeshellarg(PHP_BINARY),
        escapeshellarg($generator),
        $commandCount,
        escapeshellarg($commandsFile)
    );
    if (runCommand($cmd) !== 0) {
        logError('gen-commands failed', ['iter' => number_format($iteration)]);
        logSummary('gen-commands-failed', $totalRuns, $totalCommands, $startTime);
        exit(3);
    }

    $cmd = sprintf(
        '%s %s %s %s %s %d',
        escapeshellarg($phpOld),
        escapeshellarg($runner),
        escapeshellarg($commandsFile),
        escapeshellarg($outputOld),
        escapeshellarg($host),
        $port
    );
    if (runCommand($cmd) !== 0) {
        logError('run-commands failed', ['bin' => 'php-old', 'iter' => number_format($iteration)]);
        logSummary('run-commands-failed', $totalRuns, $totalCommands, $startTime);
        exit(4);
    }

    $cmd = sprintf(
        '%s %s %s %s %s %d',
        escapeshellarg($phpNew),
        escapeshellarg($runner),
        escapeshellarg($commandsFile),
        escapeshellarg($outputNew),
        escapeshellarg($host),
        $port
    );
    if (runCommand($cmd) !== 0) {
        logError('run-commands failed', ['bin' => 'php-new', 'iter' => number_format($iteration)]);
        logSummary('run-commands-failed', $totalRuns, $totalCommands, $startTime);
        exit(5);
    }

    $cmd = sprintf(
        '%s %s %s %s',
        escapeshellarg(PHP_BINARY),
        escapeshellarg($comparator),
        escapeshellarg($outputOld),
        escapeshellarg($outputNew)
    );
    $compareExitCode = runCommand($cmd);

    $totalRuns++;
    $totalCommands += $commandCount;

    if ($compareExitCode !== 0) {
        logError('Diff found', [
            'iter' => number_format($iteration),
            'cmdfile' => $commandsFile,
            'old' => $outputOld,
            'new' => $outputNew,
            'dur' => formatDuration(microtime(true) - $iterationStart),
        ]);
        logSummary('difference-detected', $totalRuns, $totalCommands, $startTime);
        exit(1);
    }

    logInfo('Iter ok', [
        'iter' => number_format($iteration),
        'dur' => formatDuration(microtime(true) - $iterationStart),
        'runs' => number_format($totalRuns),
        'cmds' => number_format($totalCommands),
    ]);

    $iteration++;

    if ($sleepSeconds > 0) {
        sleep($sleepSeconds);
    }
}

function usage(): void
{
    fwrite(
        STDERR,
        <<<TXT
Usage: compare-loop --old=/path/php-old --new=/path/php-new
  [--iters=0] [--sleep=0] [--count=200] [--host=127.0.0.1] [--port=6379]
TXT
    );
}

function getRedisVersion(string $phpBinary): string
{
    return trim((string) shell_exec(
        sprintf(
            '%s -r %s',
            escapeshellarg($phpBinary),
            escapeshellarg("echo phpversion('redis');")
        )
    ));
}

function buildWorkDir(): string
{
    $work = rtrim(sys_get_temp_dir(), DIRECTORY_SEPARATOR) .
        DIRECTORY_SEPARATOR .
        'phpredis_diff_' .
        getmypid();

    if (!mkdir($work, 0700) && !is_dir($work)) {
        fwrite(STDERR, "Failed to mkdir {$work}\n");
        exit(2);
    }

    return $work;
}

function runCommand(string $command): int
{
    exec($command . ' 2>&1', $output, $code);
    return (int) $code;
}

function logInfo(string $message, array $context = []): void
{
    logLine('INFO', $message, $context, STDOUT);
}

function logError(string $message, array $context = []): void
{
    logLine('ERROR', $message, $context, STDERR);
}

function logLine(string $level, string $message, array $context, $stream): void
{
    $timestamp = (new DateTimeImmutable())->format('Y-m-d H:i:s');
    $line = sprintf('[%s] %-5s %s', $timestamp, strtoupper($level), $message);

    if ($context !== []) {
        $line .= ' ' . formatContext($context);
    }

    fwrite($stream, $line . PHP_EOL);
}

function formatContext(array $context): string
{
    ksort($context);

    $parts = [];
    foreach ($context as $key => $value) {
        if (is_float($value)) {
            $value = rtrim(rtrim(sprintf('%.4f', $value), '0'), '.');
        }

        $parts[] = sprintf('%s=%s', $key, $value);
    }

    return implode(' ', $parts);
}

function logSummary(string $status, int $totalRuns, int $totalCommands, float $startTime): void
{
    logInfo('Summary', [
        'status' => $status,
        'runs' => number_format($totalRuns),
        'cmds' => number_format($totalCommands),
        'time' => formatDuration(microtime(true) - $startTime),
    ]);
}

function formatDuration(float $seconds): string
{
    if ($seconds < 0) {
        $seconds = 0.0;
    }

    if ($seconds < 1) {
        return sprintf('%dms', (int) round($seconds * 1000));
    }

    $parts = [];

    $hours = (int) floor($seconds / 3600);
    if ($hours > 0) {
        $parts[] = $hours . 'h';
        $seconds -= $hours * 3600;
    }

    $minutes = (int) floor($seconds / 60);
    if ($minutes > 0) {
        $parts[] = $minutes . 'm';
        $seconds -= $minutes * 60;
    }

    $seconds = round($seconds, 2);
    $parts[] = sprintf('%0.2fs', $seconds);

    return implode('', $parts);
}
